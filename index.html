<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The World's Best Cave Exploring App</title>
  <link rel="icon" href="favicon.ico">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    body { margin: 0; font-family: sans-serif; }
    #map { height: 70vh; width: 100vw; }
    #info { padding: 1em; }
    .visited { background-color: green; color: white; }
    .popup-content button { margin-top: 0.5em; }
    .navigate-link { display: inline-block; margin-top: 0.5em; color: #0645AD; text-decoration: underline; }
    #marker-list { padding: 0.5em 1em 1em 1cm; margin-left: 1cm; list-style-type: none; max-width: 600px; font-size: 0.95em; }
  </style>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Grottor">
<link rel="apple-touch-icon" href="icons/icon-192.png">  
</head>
<body>

<div id="map"></div>

<div id="info" style="margin-bottom: 0.25em;">
  <h4>‚ÑπÔ∏è Info</h4>
  <p style="margin-bottom: 0.25em;">Det h√§r √§r v√§rldens b√§sta grottutforskar-app!</p>
</div>

<div style="padding: 1em; margin-left: 1cm; display: flex; gap: 1em; align-items: center; max-width: 600px;">
  <button onclick="centerOnUser()">Centrera p√• min plats</button>
  <button onclick="resetMarkers()">√Öterst√§ll platser</button>
</div>

<br>

<div style="padding: 0 1em 0em 1cm; max-width: 600px;">
  <label for="filter">Visa:
    <select id="filter" onchange="applyFilter()">
      <option value="all">Alla</option>
      <option value="visited">Bes√∂kta</option>
      <option value="notvisited">Ej bes√∂kta</option>
    </select>
  </label>
</div>

<ul id="marker-list"></ul>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const defaultMarkers = [];  // L√§gg till dina standardgrottor h√§r om du vill

let markers = JSON.parse(localStorage.getItem('markers')) || [...defaultMarkers];

const map = L.map('map').setView([60.3755, 16.0244], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

async function loadCavesFromGitHub() {
  if (localStorage.getItem('markers')) {
    console.log("Anv√§nder marker fr√•n localStorage ‚Äì anv√§ndarens √§ndringar bevaras.");
    applyFilter();
    return;
  }

  try {
    const response = await fetch("https://raw.githubusercontent.com/Xzyrxios/Grottor/main/caves.json");
    if (!response.ok) throw new Error(`Misslyckades ladda caves.json: ${response.status}`);

    const caves = await response.json();
    markers = caves;
    saveMarkers(); // üß† Spara till localStorage direkt
    applyFilter();
    console.log("Caves laddade fr√•n GitHub:", markers);
  } catch (error) {
    console.error("Fel vid laddning:", error);
  }
}
// Ladda grottor EFTER att 'markers' √§r deklarerad
loadCavesFromGitHub();

function resetMarkers() {
  if (!confirm('Vill du √•terst√§lla dina bes√∂kta platser?\nSidan laddas om.')) return;
  localStorage.removeItem('markers');
  document.getElementById('filter').value = 'all';
  showSnackbar('Platser √•terst√§llda');
  setTimeout(() => location.reload(), 1500);
}

function saveMarkers() {
  localStorage.setItem('markers', JSON.stringify(markers));
}

function markVisited(id) {
  const marker = markers.find(m => m.id === id);
  if (marker) {
    marker.visited = !marker.visited;
    saveMarkers();
    applyFilter();
  }
}

function renderMarkers(filter = 'all') {
  map.eachLayer(layer => {
    if (layer instanceof L.Marker && !layer._isUserMarker) {
      map.removeLayer(layer);
    }
  });

  let filtered = markers;
  if (filter === 'visited') filtered = markers.filter(m => m.visited);
  if (filter === 'notvisited') filtered = markers.filter(m => !m.visited);

  filtered.forEach(m => {
    const iconColor = m.visited ? 'green' : 'blue';
    const marker = L.marker([m.lat, m.lng], {
      icon: L.icon({
        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${iconColor}.png`,
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      })
    }).addTo(map);
    marker._isUserMarker = false;
    const gmapsLink = `https://www.google.com/maps/search/?api=1&query=${m.lat},${m.lng}`;
    const popupHtml = `
      <div class="popup-content">
        <b>${m.name}</b><br/>
        <small style='color: #555;'>${m.location || ''}</small><br/>
        <p>${m.description || ''}</p>
        ${m.history ? `<em>${m.history}</em><br/>` : ''}
        <button onclick="markVisited(${m.id})" class="${m.visited ? 'visited' : ''}">
          ${m.visited ? 'Bes√∂kt' : 'Markera som bes√∂kt'}</button><br/>
        <a href="${gmapsLink}" target="_blank" class="navigate-link">Navigera till platsen</a>
      </div>`;
    marker.bindPopup(popupHtml);
  });
}

function renderList(sortedMarkers) {
  const list = document.getElementById('marker-list');
  if (!list) return;
  list.innerHTML = '';
  const distMap = Object.fromEntries(sortedMarkers.map(m => [m.id, m.dist || null]));
  const sorted = [...sortedMarkers].sort((a, b) => (a.dist || Infinity) - (b.dist || Infinity));
  sorted.forEach(m => {
    const dist = distMap[m.id];
    const li = document.createElement('li');
    const distance = dist ? ` (${(dist * 111).toFixed(1)} km)` : '';
    const visitedText = m.visited ? '<span style="color:green;">Bes√∂kt: Ja</span>' : '<span style="color:gray;">Bes√∂kt: Nej</span>';
    li.innerHTML = `<strong style='color: #0645AD;'>${m.name}${distance}</strong> ${visitedText}<br/>
      <small>${m.location || ''}</small><br/>
      ${m.description ? `<p>${m.description}</p>` : '<em style="font-size: 0.75em; color: #888;">(saknar beskrivning)</em>'}
      ${m.history ? `<em>${m.history}</em><br/>` : ''}
      <hr/>`;
    li.style.cursor = 'pointer';
    li.addEventListener('click', () => {
      const isActive = li.style.backgroundColor === 'lightyellow';
      document.querySelectorAll('#marker-list li').forEach(el => el.style.backgroundColor = '');
      if (!isActive) {
        li.style.backgroundColor = 'lightyellow';
        map.setView([m.lat, m.lng], 14);
      }
    });
    list.appendChild(li);
  });
}

function applyFilter() {
  const filter = document.getElementById('filter').value;
  let filtered = markers;
  if (filter === 'visited') filtered = markers.filter(m => m.visited);
  if (filter === 'notvisited') filtered = markers.filter(m => !m.visited);

  let withDist = filtered.map(m => ({ ...m, dist: null }));

  if (window.__userLatLng) {
    const [userLat, userLng] = window.__userLatLng;
    withDist = filtered.map(m => {
      const dx = m.lat - userLat;
      const dy = m.lng - userLng;
      return { ...m, dist: Math.sqrt(dx * dx + dy * dy) };
    }).sort((a, b) => a.dist - b.dist);
  }

  renderMarkers(filter);
  renderList(withDist);
}

function centerOnUser() {
  if (window.__userLatLng) {
    map.setView(window.__userLatLng, 13);
  } else {
    alert('Platsdata inte tillg√§nglig √§nnu. Till√•t platstj√§nster eller f√∂rs√∂k igen.');
  }
}

if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(pos => {
    const userLat = pos.coords.latitude;
    const userLng = pos.coords.longitude;
    const userMarker = L.circleMarker([userLat, userLng], {
      radius: 7,
      color: '#3388ff',
      fillColor: '#3388ff',
      fillOpacity: 1
    }).addTo(map).bindPopup("Du √§r h√§r");
    userMarker._isUserMarker = true;
    window.__userLatLng = [userLat, userLng];
    applyFilter();
  }, () => {
    applyFilter();
  });
} else {
  applyFilter();
}

/*
function showSnackbar(msg) {
  let bar = document.getElementById('snackbar');
  if (!bar) {
    bar = document.createElement('div');
    bar.id = 'snackbar';
    bar.style =
      'display:none; position:fixed; bottom:20px; left:50%;' +
      'transform:translateX(-50%); background:#333; color:white;' +
      'padding:10px 20px; border-radius:5px; font-size:0.9em; z-index:1000;';
    document.body.appendChild(bar);
  }
  bar.textContent = msg;
  bar.style.display = 'block';
  setTimeout(() => (bar.style.display = 'none'), 2000);
}
*/
</script>

</body>
</html>
