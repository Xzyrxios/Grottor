<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The World's Best Cave Exploring App</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: sans-serif; }
    #map { height: 70vh; width: 100vw; }
    #info { padding: 1em; }
    .visited { background-color: green; color: white; }
    .popup-content button { margin-top: 0.5em; }
    .navigate-link { display: inline-block; margin-top: 0.5em; color: #0645AD; text-decoration: underline; }
    #marker-list { padding: 0.5em 1em 1em 1cm; margin-left: 1cm; list-style-type: none; max-width: 600px; font-size: 0.95em; }
  </style>
</head>
<body>

<div id="map"></div>

<div id="info" style="margin-bottom: 0.25em;">
  <h4>ℹ️ Info</h4>
  <p style="margin-bottom: 0.25em;">Det här är världens bästa grottutforskar-app!</p>
</div>

<div style="padding: 1em; margin-left: 1cm; display: flex; gap: 1em; align-items: center; max-width: 600px;">
  <button onclick="centerOnUser()">Centrera på min plats</button>
  <button onclick="resetMarkers()">Återställ platser</button>
</div>
<br/>
<div style="padding: 0 1em 0em 1cm; max-width: 600px;">
  <label for="filter">Visa:
    <select id="filter" onchange="applyFilter()">
      <option value="all">Alla</option>
      <option value="visited">Besökta</option>
      <option value="notvisited">Ej besökta</option>
    </select>
  </label>
</div>

<ul id="marker-list"></ul>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([60.3755, 16.0244], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

async function loadCavesFromGitHub() {
  try {
    const response = await fetch(
      "https://raw.githubusercontent.com/Xzyrxios/Grottor/main/caves.json");
    if (!response.ok) {
      throw new Error(`Failed to fetch caves.json: ${response.status}`);
    }
    const caves = await response.json();
    markers = caves;
    applyFilter(); // Render the map and list with the new data
    console.log("Caves loaded successfully:", markers);
  } catch (error) {
    console.error("Error loading caves:", error);
  }
}

// Call the function to load caves
loadCavesFromGitHub();
let markers = JSON.parse(localStorage.getItem('markers')) || [...defaultMarkers];

function resetMarkers() {
  if (!confirm('Vill du återställa dina besökta platser?\nSidan laddas om.')) return;
  localStorage.removeItem('markers');
  document.getElementById('filter').value = 'all';
  showSnackbar('Platser återställda');
  setTimeout(() => location.reload(), 1500);
}

function saveMarkers() {
  localStorage.setItem('markers', JSON.stringify(markers));
}

function markVisited(id) {
  const marker = markers.find(m => m.id === id);
  if (marker) {
    marker.visited = !marker.visited;
    saveMarkers();
    applyFilter();
  }
}

function renderMarkers(filter = 'all') {
  // Remove existing markers, except the user marker
  map.eachLayer(layer => {
    if (layer instanceof L.Marker && !layer._isUserMarker) {
      map.removeLayer(layer);
    }
  });

  // Filter markers based on the filter option
  let filtered = markers;
  if (filter === 'visited') filtered = markers.filter(m => m.visited);
  if (filter === 'notvisited') filtered = markers.filter(m => !m.visited);

  // Add filtered markers to the map
filtered.forEach(m => {
  const iconColor = m.visited ? 'green' : 'blue';
  const marker = L.marker([m.lat, m.lng], {
    icon: L.icon({
      iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${iconColor}.png`,
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    })
  }).addTo(map);
  marker._isUserMarker = false;
  const gmapsLink = `https://www.google.com/maps/search/?api=1&query=${m.lat},${m.lng}`;
  const popupHtml = `
    <div class="popup-content">
      <b>${m.name}</b><br/>
      <small style='color: #555;'>${m.location || ''}</small><br/>
      <p>${m.description || ''}</p>
      ${m.history ? `<em>${m.history}</em><br/>` : ''}
      <button onclick="markVisited(${m.id})" class="${m.visited ? 'visited' : ''}">
        ${m.visited ? 'Besökt' : 'Markera som besökt'}</button><br/>
      <a href="${gmapsLink}" target="_blank" class="navigate-link">Navigera till platsen</a>
    </div>`;
  marker.bindPopup(popupHtml);
});

function renderList(sortedMarkers) {
  const list = document.getElementById('marker-list');
  if (!list) return;
  list.innerHTML = '';
  const distMap = Object.fromEntries(sortedMarkers.map(m => [m.id, m.dist || null]));
  const sorted = [...sortedMarkers].sort((a, b) => (a.dist || Infinity) - (b.dist || Infinity));
  sorted.forEach(m => {
    const dist = distMap[m.id];
    const li = document.createElement('li');
    const distance = dist ? ` (${(dist * 111).toFixed(1)} km)` : '';
    const visitedText = m.visited ? '<span style="color:green;">Besökt: Ja</span>' : '<span style="color:gray;">Besökt: Nej</span>';
    li.innerHTML = `<strong style='color: #0645AD;'>${m.name}${distance}</strong> ${visitedText}<br/>
      <small>${m.location || ''}</small><br/>
      ${m.description ? `<p>${m.description}</p>` : '<em style="font-size: 0.75em; color: #888;">(saknar beskrivning)</em>'}
      ${m.history ? `<em>${m.history}</em><br/>` : ''}
      <hr/>`;
    li.style.cursor = 'pointer';
    li.addEventListener('click', () => {
      const isActive = li.style.backgroundColor === 'lightyellow';
      document.querySelectorAll('#marker-list li').forEach(el => el.style.backgroundColor = '');
      if (!isActive) {
        li.style.backgroundColor = 'lightyellow';
        map.setView([m.lat, m.lng], 14);
      }
    });
    list.appendChild(li);
  });
}

function applyFilter() {
  const filter = document.getElementById('filter').value;
  let filtered = markers;
  if (filter === 'visited') filtered = markers.filter(m => m.visited);
  if (filter === 'notvisited') filtered = markers.filter(m => !m.visited);

  let withDist = filtered.map(m => ({ ...m, dist: null }));

  if (window.__userLatLng) {
    const [userLat, userLng] = window.__userLatLng;
    withDist = filtered.map(m => {
      const dx = m.lat - userLat;
      const dy = m.lng - userLng;
      return { ...m, dist: Math.sqrt(dx * dx + dy * dy) };
    }).sort((a, b) => a.dist - b.dist);
  }

  renderMarkers(filter);
  renderList(withDist);
}

function centerOnUser() {
  if (window.__userLatLng) {
    map.setView(window.__userLatLng, 13);
  } else {
    alert('Platsdata inte tillgänglig ännu. Tillåt platstjänster eller försök igen.');
  }
}

if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(pos => {
    const userLat = pos.coords.latitude;
    const userLng = pos.coords.longitude;
    const userMarker = L.circleMarker([userLat, userLng], {
      radius: 7,
      color: '#3388ff',
      fillColor: '#3388ff',
      fillOpacity: 1
    }).addTo(map).bindPopup("Du är här");
    userMarker._isUserMarker = true;
    window.__userLatLng = [userLat, userLng];
    applyFilter();
  }, () => {
    applyFilter();
  });
} else {
  applyFilter();
}

function showSnackbar(msg) {
  let bar = document.getElementById('snackbar');
  if (!bar) {
    bar = document.createElement('div');
    bar.id = 'snackbar';
    bar.style = 'display:none; position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#333; color:white; padding:10px 20px; border-radius:5px; font-size:0.9em; z-index:1000;';
    document.body.appendChild(bar);
  }
  bar.textContent = msg;
  bar.style.display = 'block';
  setTimeout(() => (bar.style.display = 'none'), 2000);
}
  
</script>

</body>
</html>
